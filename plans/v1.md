# Replay

## Overview
The website is called "Replay". The website will create a playlist for the user and keep it up to date with their most recently played music. The user can then chose to share the playlist with others.

The website allows the user to log in with their spotify credentials. The site will store the user's oauth token to be used with the spotipy library. The site will have a cron job that runs frequently to update the playlist with the user's most recently played songs. 

## Requirements
- Website must have a python backend
- Frontend should be very simple. Allow a user to log in and name the newly created playlist.
- Backend must store the name of the playlist and oauth token.
- Python requirements should be stored in requirements.txt
- Use pip. Do not use uv.

## Plan

### Backend Setup
1. Initialize Python project with FastAPI.
2. Set up database Sqlite to store:
   - User ID
   - Spotify OAuth token
   - Playlist name
   - Playlist ID
3. Implement Spotify OAuth flow:
   - Redirect to Spotify login
   - Handle callback and store access token
4. Create cron job for playlist updates:
   - Fetch user's recently played tracks
   - Add new tracks to their playlist
   - Run on a schedule (e.g., hourly)

### Frontend Setup
1. Create simple login page:
   - "Login with Spotify" button
   - Redirects to backend OAuth endpoint
2. Create playlist creation page:
   - Input field for playlist name
   - Submit button
   - Confirmation after creation

### API Endpoints
- `GET /login` - Initiate Spotify OAuth
- `GET /callback` - Handle Spotify OAuth callback
- `POST /playlist` - Create new playlist (requires name)
- `GET /user` - Get current user info (if authenticated)

### Database Schema
- Users table: id, spotify_id, access_token, refresh_token, token_expires_at
- Playlists table: id, user_id, playlist_name, spotify_playlist_id, created_at

## Implementation Details

### Logging
- Centralized logging configuration in `config.py`
- All logs output to console (stdout) with timestamps and log levels
- Comprehensive logging throughout API endpoints and cron job for debugging
- Log format: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`

### API Endpoints Detail
- `POST /playlist` - Expects form-encoded data (playlist_name, user_id) in request body, not query params
- All endpoints include detailed logging for request tracing

### Playlist Update Logic (Cron Job)
- Separate `update_playlists.py` script (not in main app) to be run via cron
- Update frequency: Configurable via cron schedule (e.g., hourly)
- For each user's playlist:
  - Fetch currently playing track (if any)
  - Fetch recently played tracks (limit 50)
  - Add new tracks to **top** of playlist (position=0)
  - Keep most recent tracks always at the top
  - **Cap playlist at 100 tracks maximum**
  - Remove oldest tracks from the end if capacity exceeded
  - Handle pagination for playlists with 100+ tracks
  - Currently playing track is added to top first (before recently played)
- Token refresh: Automatically refresh expired Spotify tokens before updating
- Error handling: Per-user try/catch so one user's error doesn't block others

### Spotify OAuth Scopes
- `user-read-currently-playing` - Read currently playing track
- `user-read-recently-played` - Read recently played tracks
- `playlist-modify-public` - Modify public playlists
- `playlist-modify-private` - Modify private playlists

### Configuration
- Centralized `config.py` file for:
  - Spotify OAuth setup (credentials, scopes, sp_oauth instance)
  - Logging configuration
  - Shared constants (e.g., MAX_PLAYLIST_CAPACITY = 100)

### Code Organization
- `main.py` - FastAPI application and endpoints
- `update_playlists.py` - Cron job script with modular functions:
  - `refresh_user_token_if_expired()` - Token management
  - `get_current_track_id()` - Currently playing track
  - `get_recently_played_track_ids()` - Recently played tracks
  - `get_playlist_track_ids()` - Playlist tracks with pagination
  - `get_new_track_ids()` - Determine tracks to add
  - `maintain_playlist_capacity()` - Remove excess tracks
  - `add_tracks_to_playlist()` - Add tracks to top
  - `update_user_playlists()` - Update all user playlists
- `config.py` - Centralized configuration
- `models.py` - Database models
- `templates/` - HTML templates for frontend
- `static/` - Static assets